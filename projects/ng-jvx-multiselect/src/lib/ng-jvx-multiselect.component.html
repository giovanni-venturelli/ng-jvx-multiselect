
<div class="ng-jvx-multiselect" [class.disabled]="disabled" [class.has-errors]="hasErrors" #jvxMultiselect>
  <!-- START MENU -->
  <div [libMenuTriggerFor]="menuRef" (onMenuOpen)="onMenuOpen()" (menuOpened)="onMenuOpened()"
       #trigger
       (onMenuClose)="onMenuClose()" (menuClosed)="onMenuClosed()"
  >
    <lib-panel #menuRef [class]="['jvx-multiselect-panel', panelClass].join(' ')" [multi]="multi" [formGroup]="form"
               [yPosition]="yPosition()">
      @if (closeButton) {
        <div class="closeMenuButton">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256">
            <path
              d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
          </svg>
        </div>
      }
      <div style="display: flex; flex-direction: column"
           [ngStyle]="{'overflow-y': 'hidden', 'width': listContainerSize().width, 'min-width.px': 112, 'max-height': '300px', 'height': listContainerSize().height}">
      <div class="menu-list-container"
           [style.flex]="'1 1 0'"
           #menuLIstContainer
           >
        <div class="search-input-container" *ngIf="!!searchInput" (click)="onSearchInputClick($event)">
          <input type="text" [placeholder]="searchLabel" [ngModel]="searchValue" [ngModelOptions]="{standalone: true}"
                 [ngJvxFocus]="isOpen()"
                 (input)="onSearchValueChange($event)"/>
        </div>
        <div
          [ngStyle]="{height: searchInput && selectionContainer.clientHeight > 220 || selectionContainer.clientHeight > 300? 300 - (searchInput? 40 : 0) - menuFooter.offsetHeight + 'px': 'auto'}">
          <ng-scrollbar style="width: 100%"
                        smoothScroll
                        [visibility]="'hover'"
                        [appearance]="'compact'"
                        [sensorDisabled]="isLoading()"
                        [autoHeightDisabled]="false" #scrollbar>
            <div #selectionContainer (click)="onCLickOnMenu($event)">
              <div #selection
                   *ngIf="showList"
                   [ngStyle]="{'padding': 0, 'width': listContainerSize().width, 'min-width.px': 112}"
                   ngDefaultControl
                   formControlName="selectionValue">
                <ng-content></ng-content>
                <ng-container *ngIf="!!groupBy">
                  <ng-container *ngFor="let opt of orderedOptions">
                    <ng-container
                      [ngTemplateOutlet]="groupHeaderTemplate? groupHeaderTemplate.template: defaultGroupHeaderTemplate"
                      [ngTemplateOutletContext]="{$implicit: opt}"></ng-container>

                    <ng-jvx-option *ngFor="let option of opt.options" [value]="option[itemValue]"
                                   [isSelected]="isOptionSelected(option)" (click)="clickOnOption(option)">
                      <!--        <ng-container [ngTemplateOutlet]="optionsTemplate" [ngTemplateOutletContext]="{$implicit: option}"></ng-container>-->
                      <div class="ng-jvx-option-wrapper" style="min-height:48px">
                        <ng-container [ngTemplateOutlet]="optionsTemplate? optionsTemplate.template : defaultTemplate"
                                      [ngTemplateOutletContext]="{$implicit: option}"></ng-container>
                      </div>
                    </ng-jvx-option>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!groupBy || ( typeof groupBy === 'string' && groupBy.length === 0)">
                  <ng-jvx-option *ngFor="let option of selectableOptions" [value]="option[itemValue]"
                                 [isSelected]="isOptionSelected(option)" (click)="clickOnOption(option)">
                    <div class="ng-jvx-option-wrapper" style="min-height:48px">
                      <!--        <ng-container [ngTemplateOutlet]="optionsTemplate" [ngTemplateOutletContext]="{$implicit: option}"></ng-container>-->
                      <ng-container [ngTemplateOutlet]="optionsTemplate? optionsTemplate.template : defaultTemplate"
                                    [ngTemplateOutletContext]="{$implicit: option}"></ng-container>
                    </div>
                  </ng-jvx-option>
                </ng-container>
              </div>
            </div>
          </ng-scrollbar>
        </div>

      </div>
      <div class="menu-footer" #menuFooter>
        <ng-content select="[ng-jvx-footer]"></ng-content>
      </div>
      </div>
    </lib-panel>
  </div>
  <!-- END MENU -->
  <!-- START INPUT -->
  <div [ngClass]="{'ng-jvx-multiselect-value-container': true, 'is-open': isOpen()}"
       (click)="clickOnMenuTrigger($event)"
       #valueContainer>
    @if (value.length === 0) {
      <div class="ng-jvx-multiselect__placeholder" #placeholderContainer>
        <ng-content select="[placeholder]"></ng-content>
      </div>
    }
    <div class="ng-jvx-multiselect-value multi-value-container" *ngIf="multi" #multiContainer>
      <ng-container [ngTemplateOutlet]="selectionTemplate? selectionTemplate.template : defaultMultiSelectionTemplate"
                    [ngTemplateOutletContext]="{$implicit: value}"></ng-container>

    </div>

    <div class="ng-jvx-multiselect-value single-value-container" *ngIf="!multi">
      <div *ngFor="let val of value" style="width: 100%;">
        <ng-container [ngTemplateOutlet]="selectionTemplate? selectionTemplate.template : defaultSelectionTemplate"
                      [ngTemplateOutletContext]="{$implicit: val}"></ng-container>
      </div>
    </div>
    @if (clearable && value.length > 0) {
      <div class="ng-jvx-multiselect__remove-button" (click)="clear($event)">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#000000" viewBox="0 0 256 256">
          <path
            d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
        </svg>
      </div>
    }
    <div class="ng-jvx-multiselect-arrow">
      @if (!isLoading()) {
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#000000" viewBox="0 0 256 256">
          <path
            d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"></path>
        </svg>
      } @else {
        <div class="lds-ring">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
      }
    </div>
  </div>
  <!-- END INPUT -->
</div>
<ng-template #defaultTemplate let-option>
  <div style="min-height: 48px; height: 100%; display: flex; align-items: center">
    <div style="max-width: 100%;
  padding-inline: .3rem;
     white-space: nowrap;
     overflow: hidden;
     text-overflow: ellipsis;">{{ option[itemText] }}
    </div>
  </div>
</ng-template>

<ng-template #defaultSelectionTemplate let-value>
  {{ value[itemText] }}
</ng-template>

<ng-template #defaultMultiSelectionTemplate let-value>
  <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
    @for (val of value; track val[itemValue]) {
      <ng-jvx-multiselect-chip [value]="val" class="ng-jvx-multiselect-chip" [disabled]="this.disabled" >
        {{ val[itemText] }}
      </ng-jvx-multiselect-chip>
    }
  </div>
</ng-template>
<ng-template #defaultGroupHeaderTemplate let-opt>
  <div style="padding-inline: 15px"><strong>{{ opt.group }}</strong></div>
</ng-template>
